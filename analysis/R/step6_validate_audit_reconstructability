suppressPackageStartupMessages({
  library(fs)
  library(readr)
  library(dplyr)
  library(jsonlite)
  library(digest)
})

log <- readr::read_csv(fs::path("outputs", "decision_log.csv"), show_col_types = FALSE)

read_ndjson <- function(path) {
  lines <- readr::read_lines(path)
  objs <- lapply(lines, jsonlite::fromJSON, simplifyVector = FALSE)
  tibble(raw = objs)
}

aud <- read_ndjson(fs::path("outputs", "audit_events.ndjson"))
prov <- read_ndjson(fs::path("outputs", "provenance.ndjson"))

extract_decision_id <- function(a) {
  ex <- a$extension
  if (is.null(ex)) return(NA_character_)
  vals <- vapply(ex, function(e) if (!is.null(e$url) && e$url == "urn:bu:governance:decision") e$valueString else NA_character_, character(1))
  vals <- vals[!is.na(vals)]
  if (length(vals) == 0) NA_character_ else vals[[1]]
}

aud_keys <- aud %>%
  mutate(decision_id = vapply(raw, extract_decision_id, character(1))) %>%
  filter(!is.na(decision_id)) %>%
  distinct(decision_id)

expected <- nrow(log)
observed <- nrow(aud_keys)
coverage <- observed / expected

missing <- log %>%
  anti_join(aud_keys, by = "decision_id") %>%
  summarise(missing_n = n()) %>%
  pull(missing_n)

table3 <- tibble(
  metric = c("decisions_expected", "audit_events_observed", "audit_coverage", "missing_audit_events"),
  value = c(expected, observed, coverage, missing)
)

report <- list(
  decisions_expected = expected,
  audit_events_observed = observed,
  audit_coverage = coverage,
  missing_audit_events = missing,
  reconstructable = missing == 0
)

jsonlite::write_json(report, fs::path("outputs", "validation_report.json"), auto_unbox = TRUE, pretty = TRUE)
readr::write_csv(table3, fs::path("outputs", "table_audit_metrics.csv"))
